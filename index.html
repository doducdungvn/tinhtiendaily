<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Báo cáo thu tiền 5.0 - Zeng</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* --- CÀI ĐẶT CHUNG CHO CẢ PC VÀ MOBILE --- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 15px;
      background: #f4f7f9;
      color: #333;
      font-size: 16px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 10px;
    }
    h2 {
      text-align: center;
      color: #2c3e50;
      font-size: 28px;
    }
    .main-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .controls-panel {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #dfe6e9;
      border-radius: 8px;
      background: #fff;
    }
    label {
      font-weight: bold;
      color: #555;
    }
    input[type="text"], input[type="file"], input[type="number"], select, button {
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
    }
    
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      transition: background-color 0.3s, color 0.3s;
      font-weight: bold;
    }
    button.secondary { background-color: #6c757d; }
    button.danger { background-color: #e74c3c; }
    button:hover { opacity: 0.85; }

    table {
      border-collapse: collapse;
      width: 100%;
      margin: 1px auto;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    th, td {
      border: 1px solid #dee2e6;
      padding: 12px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #f8f9fa;
      color: #495057;
      font-size: 17px;
    }
    .report-table { table-layout: fixed; }
    .report-table th { width: 33.33%; }
    
    .report-table tbody td {
      font-weight: bold;
      font-size: 18px; 
    }

    .header { font-weight: bold; background: #f8f9fa; }
    .so-so {
      font-size: 39px;
      font-weight: bold;
      color: #d35400;
      vertical-align: middle;
    }
    
    .must-pay {
      background: #ffebee;
      font-size: 28px !important;
      color: #c0392b;
    }
    .must-pay td:first-child, .must-pay td:last-child { font-weight: bold; }
    
    .old-debt { 
        background-color: #fdf5e6;
    }

    #tongCongRow {
        background-color: #eaf2f8;
        color: #2c3e50;
    }
    #mainBonusRow {
        background-color: #e9f7ef;
        color: #1e8449;
    }
    #mainBonusRow td {
        font-weight: bold;
    }
    
    .added-ticket-row { 
        background-color: #e8f6f8;
    }
    .added-ticket-row td:first-child {
      color: #0e6251;
      font-size: 15px;
    }
    
    .bang-chu-cell {
      text-align: left !important;
      font-style: italic;
      padding-left: 15px !important;
      font-size: 9px;
      font-weight: normal;
    }

    .ticket-type-selector { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
    .ticket-type-selector label { display: flex; align-items: center; gap: 5px; font-weight: normal; }
    .copyright {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: #6c757d;
    }
    
    #actionButtonContainer, #actionChoices {
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
    }
    #actionChoices { grid-column: 1 / -1; margin-top: 10px; }
    .dynamic-input {
        width: 100%;
        border: none;
        font-weight: bold;
        text-align: center;
        background: transparent;
        font-size: 18px;
	    padding-left: 5px;
        resize: none;
        overflow-y: hidden;
    }

    @media (max-width: 768px) {
      body {
        margin: 8px;
        font-size: 4vw;
        -webkit-text-size-adjust: 100%;
      }
      .container { padding: 5px; }
      h2 { font-size: 6.5vw; }
      label { font-size: 4.2vw; }
      input[type="text"], input[type="file"], input[type="number"], select, button {
        padding: 12px;
        font-size: 4.5vw;
      }
      th, td {
        padding: 8px;
        font-size: 4.8vw;
        word-break: break-word;
      }
      .so-so { font-size: 6vw; word-break: break-all; }
      .must-pay { font-size: 14vw !important; }
      .bang-chu-cell { font-size: 4vw !important; }
      .copyright { font-size: 3.5vw; }
      .added-ticket-row td:first-child { font-size: 4vw; }
      .dynamic-input { font-size: 4vw !important; }
    }
  </style>
</head>
<body>
  <div class="container">
     <h3>ZENG™</h3>
    <h2>Bán vé & Báo cáo thu tiền</h2>

    <div class="main-controls">
        <button id="toggleSellBtn" onclick="toggleSellMode()">Bán vé</button>
        <button class="secondary" onclick="toggleReportControls()">Xem Báo Cáo Thu Tiền</button>
    </div>

    <div id="sellTicketControls" class="controls-panel" style="display:none;">
        <div>
            <label>Loại hình:</label>
            <div class="ticket-type-selector">
                <label><input type="radio" name="sellTicketType" value="xo-so" onchange="handleTicketTypeChange()" checked> Xổ số</label>
                <label><input type="radio" name="sellTicketType" value="ve-boc" onchange="handleTicketTypeChange()"> Vé bóc</label>
                <label><input type="radio" name="sellTicketType" value="custom-name" onchange="handleTicketTypeChange()"> Tự nhập tên</label>
            </div>
            <input type="text" id="customTicketName" placeholder="Nhập tên loại hình..." style="display:none; margin-top: 5px;" onkeydown="handleSellTicketEnter(this, event)">
        </div>
        <div>
            <label>Giá bán:</label>
            <div class="ticket-type-selector">
                <label><input type="radio" name="sellPrice" value="10000" onchange="updateCustomFieldVisibility()" checked> 10.000</label>
                <label><input type="radio" name="sellPrice" value="20000" onchange="updateCustomFieldVisibility()"> 20.000</label>
                <label><input type="radio" name="sellPrice" value="5000" onchange="updateCustomFieldVisibility()"> 5.000</label>
                <label><input type="radio" name="sellPrice" value="custom-price" onchange="updateCustomFieldVisibility()"> Tự nhập giá</label>
            </div>
            <input type="text" id="customTicketPrice" inputmode="numeric" placeholder="Nhập giá bán..." style="display:none; margin-top: 5px;" oninput="formatCustomPrice(this)" onkeydown="handleSellTicketEnter(this, event)">
        </div>
        <div>
            <label>Hoa hồng:</label>
            <div class="ticket-type-selector">
                <label><input type="radio" name="commissionRate" value="0.10" onchange="updateCustomFieldVisibility()" checked> 10%</label>
                <label><input type="radio" name="commissionRate" value="0.12" onchange="updateCustomFieldVisibility()"> 12%</label>
                <label><input type="radio" name="commissionRate" value="custom-commission" onchange="updateCustomFieldVisibility()"> Tự nhập %</label>
            </div>
            <input type="number" id="customCommissionPercent" placeholder="Nhập % hoa hồng (ví dụ: 15)" style="display:none; margin-top: 5px;" min="0" onkeydown="handleSellTicketEnter(this, event)">
        </div>
        <div>
            <label for="sellQuantityInput">Số lượng:</label>
            <input type="number" id="sellQuantityInput" placeholder="Nhập số lượng vé..." min="0" onkeydown="if (event.key === 'Enter') { event.preventDefault(); addTicketToReport(); this.blur(); }">
        </div>
        <button onclick="addTicketToReport()">Thêm vé vào báo cáo</button>
    </div>

    <div id="reportControlsContainer" class="controls-panel" style="display:none;">
      <label for="soSo">Nhập số sổ (ví dụ: 550):</label>
      <input type="text" id="soSo" inputmode="numeric" placeholder="Nhập số sổ gốc để gộp" onkeydown="if (event.key === 'Enter') { this.blur(); loadData(); }">
      <label for="excelFile">Chọn file Excel:</label>
      <input type="file" id="excelFile" accept=".xls,.xlsx">
      <button onclick="loadData()">Tạo báo cáo</button>
    </div>

    <div id="report"></div>
    
    <div id="actionButtonContainer">
        <button onclick="copyReportAsImage()">Sao chép để Gửi</button>
        <button id="toggleChoicesBtn" class="secondary" onclick="toggleActionChoices()">Thêm tiền Thưởng/Nợ</button>
        <div id="actionChoices"></div>
    </div>

    <div class="copyright">
      © 2025 by ZENG™
    </div>
  </div>

<script>
    let excelData = [];
    let dateRangeText = "Chưa có ngày";

    function handleEnterKey(event, nextElementId) {
        if (event.key === 'Enter') {
            event.preventDefault();
            if (nextElementId) {
                document.getElementById(nextElementId)?.focus();
            } else {
                event.target.blur();
            }
        }
    }

    function handleSellTicketEnter(currentElement, event) {
        if (event.key !== 'Enter') return;
        event.preventDefault();
        const potentialNextIds = ['customTicketName', 'customTicketPrice', 'customCommissionPercent', 'sellQuantityInput'];
        const currentIndex = potentialNextIds.indexOf(currentElement.id);
        for (let i = currentIndex + 1; i < potentialNextIds.length; i++) {
            const nextElement = document.getElementById(potentialNextIds[i]);
            if (nextElement && nextElement.offsetParent !== null) {
                nextElement.focus();
                return;
            }
        }
        document.getElementById('sellQuantityInput')?.focus();
    }

    function toggleSellMode() {
        const sellControls = document.getElementById('sellTicketControls');
        const toggleBtn = document.getElementById('toggleSellBtn');
        const isSelling = sellControls.style.display === 'flex';
        if (isSelling) {
            sellControls.style.display = 'none';
            toggleBtn.innerText = 'Bán vé';
            toggleBtn.classList.remove('danger');
            document.querySelectorAll('.added-ticket-row').forEach(row => row.remove());
            if (document.getElementById("report").innerHTML) tinhToan();
        } else {
            sellControls.style.display = 'flex';
            toggleBtn.innerText = 'Huỷ bán vé';
            toggleBtn.classList.add('danger');
            document.getElementById('sellQuantityInput')?.focus();
        }
    }

    function toggleReportControls() {
        const controls = document.getElementById('reportControlsContainer');
        controls.style.display = controls.style.display === 'none' ? 'flex' : 'none';
    }
    
    function handleTicketTypeChange() {
        document.getElementById('sellQuantityInput').value = '';
        const ticketType = document.querySelector('input[name="sellTicketType"]:checked').value;
        const customNameInput = document.getElementById('customTicketName');
        customNameInput.style.display = ticketType === 'custom-name' ? 'block' : 'none';

        switch (ticketType) {
            case 'xo-so':
                document.querySelector('input[name="sellPrice"][value="10000"]').checked = true;
                document.querySelector('input[name="commissionRate"][value="0.10"]').checked = true;
                document.getElementById('sellQuantityInput').focus();
                break;
            case 've-boc':
                document.querySelector('input[name="sellPrice"][value="5000"]').checked = true;
                document.querySelector('input[name="commissionRate"][value="0.12"]').checked = true;
                document.getElementById('sellQuantityInput').focus();
                break;
            case 'custom-name':
                document.querySelector('input[name="sellPrice"][value="10000"]').checked = true;
                document.querySelector('input[name="commissionRate"][value="0.10"]').checked = true;
                customNameInput.focus();
                break;
        }
        updateCustomFieldVisibility();
    }

    function updateCustomFieldVisibility() {
        const customPriceInput = document.getElementById('customTicketPrice');
        const customCommissionInput = document.getElementById('customCommissionPercent');
        customPriceInput.style.display = document.querySelector('input[name="sellPrice"]:checked').value === 'custom-price' ? 'block' : 'none';
        customCommissionInput.style.display = document.querySelector('input[name="commissionRate"]:checked').value === 'custom-commission' ? 'block' : 'none';
    }

    function formatCustomPrice(input) {
        let value = input.value.replace(/\D/g, '');
        input.value = value ? parseInt(value, 10).toLocaleString('vi-VN') : '';
    }
	
    function docso(numberStr) {
        const defaultNumbers = ['không', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
        const readThreeDigits = (threeDigits) => { let tram = parseInt(threeDigits[0]); let chuc = parseInt(threeDigits[1]); let donvi = parseInt(threeDigits[2]); let result = ""; if (tram > 0 || chuc > 0 || donvi > 0) { if (tram > 0) { result += defaultNumbers[tram] + " trăm "; } if (chuc > 0) { if (chuc === 1) { result += "mười "; } else { result += defaultNumbers[chuc] + " mươi "; } } else if (tram > 0 && donvi > 0) { result += "linh "; } if (donvi > 0) { if (chuc === 1) { if (donvi === 1) result += "một"; else if (donvi === 5) result += "lăm"; else result += defaultNumbers[donvi]; } else if (chuc > 1) { if (donvi === 1) result += "mốt"; else if (donvi === 5) result += "lăm"; else result += defaultNumbers[donvi]; } else { result += defaultNumbers[donvi]; } } } return result.trim(); }; let num = String(numberStr).replace(/[.,]/g, ''); if (num === '0') return 'Không'; if (num === '' || isNaN(parseInt(num))) return ''; let unit = ["", "nghìn", "triệu", "tỷ", "nghìn tỷ", "triệu tỷ"]; let chunks = []; while (num.length > 3) { chunks.unshift(num.slice(-3)); num = num.slice(0, -3); } if (num) { chunks.unshift(num); } let resultArr = []; let unitIndex = chunks.length - 1; for (let chunk of chunks) { let chunkStr = chunk.padStart(3, '0'); let text = readThreeDigits(chunkStr); if (text) { resultArr.push(text + " " + unit[unitIndex]); } unitIndex--; } let finalResult = resultArr.join(', ').trim(); if (finalResult.endsWith(',')) { finalResult = finalResult.slice(0, -1); } return finalResult.charAt(0).toUpperCase() + finalResult.slice(1);
    }
    
    document.getElementById("excelFile").addEventListener("change", function(e) { 
        let file = e.target.files[0]; 
        if (!file) return; 
        let reader = new FileReader(); 
        reader.onload = function(e) { 
            let data = new Uint8Array(e.target.result); 
            let workbook = XLSX.read(data, {type: "array"}); 
            let firstSheet = workbook.Sheets[workbook.SheetNames[0]]; 
            excelData = XLSX.utils.sheet_to_json(firstSheet, {defval: ""}); 
            let dateRow = excelData.find(r => Object.values(r).some(v => typeof v === "string" && v.includes("Tõ ngµy"))); 
            if (dateRow) { 
                let text = Object.values(dateRow).find(v => v.includes("Tõ ngµy")); 
                let match = text.match(/Tõ ngµy\s*(\d{2}\/\d{2})\/\d{4}.*®Õn ngµy\s*(\d{2}\/\d{2})\/\d{4}/); 
                if (match) { dateRangeText = `Từ ngày ${match[1]} đến ngày ${match[2]}`; } 
            } 
            alert("Đã nạp dữ liệu Excel thành công!");
            document.getElementById('soSo').focus();
        }; 
        reader.readAsArrayBuffer(file); 
    });

    function formatNumber(num) { if (isNaN(num) || num === "") return "0"; return Number(num).toLocaleString("vi-VN"); }

    function formatNumberHiddenK(num) {
        if (isNaN(num) || num === "" || Math.abs(num) < 1000) return "0";
        const truncatedNum = Math.floor(Number(num) / 1000);
        return truncatedNum.toLocaleString("vi-VN");
    }

    function formatCommissionCellHiddenK(revenue, commission) {
        if (!revenue || revenue === 0) return formatNumberHiddenK(commission);
        const percentage = (commission / revenue) * 100;
        const roundedPercentage = Math.round(percentage);
        return `<i style="color: #E57373; font-weight: normal;">(${roundedPercentage}%)</i> ${formatNumberHiddenK(commission)}`;
    }

    function formatCommissionCell(revenue, commission) { 
        if (!revenue || revenue === 0) return formatNumber(commission); 
        const percentage = (commission / revenue) * 100; 
        const roundedPercentage = Math.round(percentage); 
        return `<i style="color: #E57373; font-weight: normal;">(${roundedPercentage}%)</i> ${formatNumber(commission)}`; 
    }

    function addTicketToReport() {
        const reportTable = document.querySelector('.report-table');
        if (!reportTable) { alert("Vui lòng tạo báo cáo trước khi thêm vé bán!"); return; }
        const quantityInput = document.getElementById('sellQuantityInput');
        const quantity = parseInt(quantityInput.value, 10);
        if (!quantity || quantity <= 0) { alert("Vui lòng nhập số lượng vé hợp lệ!"); return; }
        let typeName = '';
        const ticketType = document.querySelector('input[name="sellTicketType"]:checked').value;
        if (ticketType === 'xo-so') { typeName = 'Xổ số'; } else if (ticketType === 've-boc') { typeName = 'Vé bóc';
        } else { typeName = document.getElementById('customTicketName').value.trim(); if (!typeName) { alert('Vui lòng nhập tên loại hình!'); return; } }
        let price = 0;
        const priceType = document.querySelector('input[name="sellPrice"]:checked').value;
        if (priceType === 'custom-price') {
            const customPriceValue = document.getElementById('customTicketPrice').value.replace(/\./g, '');
            price = parseFloat(customPriceValue) || 0;
            if (price <= 0) { alert('Vui lòng nhập giá bán hợp lệ!'); return; }
        } else { price = parseFloat(priceType); }
        let commissionRate = 0;
        const commissionType = document.querySelector('input[name="commissionRate"]:checked').value;
        if (commissionType === 'custom-commission') {
            const customCommissionValue = document.getElementById('customCommissionPercent').value;
            commissionRate = parseFloat(customCommissionValue) / 100 || 0;
            if (commissionRate <= 0) { alert('Vui lòng nhập % hoa hồng hợp lệ!'); return; }
        } else { commissionRate = parseFloat(commissionType); }
        const doanhThu = quantity * price;
        const hoaHong = doanhThu * commissionRate;
        const formattedName = `${typeName} (${price / 1000}k) [${quantity} vé]`;
        const newRow = document.createElement('tr');
        newRow.classList.add('added-ticket-row');
        newRow.innerHTML = `<td data-value-name="${formattedName}">${formattedName}</td><td data-value="${doanhThu}">${formatNumberHiddenK(doanhThu)}</td><td data-value="${hoaHong}">${formatCommissionCellHiddenK(doanhThu, hoaHong)}</td>`;
        const tongCongRow = document.getElementById('tongCongRow');
        reportTable.querySelector('tbody').insertBefore(newRow, tongCongRow);
        tinhToan();
        quantityInput.value = '';
        quantityInput.focus();
        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function loadData() {
        let soSo = document.getElementById("soSo").value.trim();
        if (!soSo) { alert("Vui lòng nhập số sổ!"); return; }
        if (!excelData.length) { alert("Vui lòng chọn file Excel trước!"); return; }
        const filteredRows = excelData.filter(r => String(r.__EMPTY).trim().endsWith(soSo));
        if (filteredRows.length === 0) { alert("Không tìm thấy số sổ nào phù hợp!"); return; }
        const totals = { account_codes: [], __EMPTY_2: 0, __EMPTY_3: 0, __EMPTY_6: 0, __EMPTY_7: 0, __EMPTY_8: 0, __EMPTY_9: 0, __EMPTY_10: 0, __EMPTY_11: 0, __EMPTY_12: 0, __EMPTY_13: 0, __EMPTY_14: 0 };
        filteredRows.forEach(row => {
            totals.account_codes.push(String(row.__EMPTY).trim());
            [2,3,6,7,8,9,10,11,12,13,14].forEach(i => {
                const key = `__EMPTY_${i}`;
                totals[key] += parseFloat(row[key]) || 0;
            });
        });
        
        let reportHTML = `
            <table>
            <tr><td class="header" style="width: 33.33%;">Thanh toán tiền Đại Lý:</td><td class="so-so">${totals.account_codes.join(', ')}</td></tr>
            <tr><td class="header">Thời gian:</td><td>${dateRangeText}</td></tr>
            </table><br>
            <table class="report-table">
            <thead>
                <tr><th>Loại hình</th><th>Doanh thu</th><th>Hoa hồng</th></tr>
            </thead>
            <tbody>
                <tr><td>Lô tô Đặc biệt</td><td data-value="${totals.__EMPTY_2}">${formatNumberHiddenK(totals.__EMPTY_2)}</td><td data-value="${totals.__EMPTY_3}">${formatCommissionCellHiddenK(totals.__EMPTY_2, totals.__EMPTY_3)}</td></tr>
                <tr><td>Lô cặp</td><td data-value="${totals.__EMPTY_6}">${formatNumberHiddenK(totals.__EMPTY_6)}</td><td data-value="${totals.__EMPTY_7}">${formatCommissionCellHiddenK(totals.__EMPTY_6, totals.__EMPTY_7)}</td></tr>
                <tr><td>2/27</td><td data-value="${totals.__EMPTY_8}">${formatNumberHiddenK(totals.__EMPTY_8)}</td><td data-value="${totals.__EMPTY_9}">${formatCommissionCellHiddenK(totals.__EMPTY_8, totals.__EMPTY_9)}</td></tr>
                <tr><td>3/23</td><td data-value="${totals.__EMPTY_10}">${formatNumberHiddenK(totals.__EMPTY_10)}</td><td data-value="${totals.__EMPTY_11}">${formatCommissionCellHiddenK(totals.__EMPTY_10, totals.__EMPTY_11)}</td></tr>
                <tr id="tongCongRow"><td>Tổng cộng</td><td id="tongDT">${formatNumberHiddenK(totals.__EMPTY_12)}</td><td id="tongHH">${formatNumberHiddenK(totals.__EMPTY_13)}</td></tr>
                <tr id="mainBonusRow"><td>Thưởng</td><td colspan="2" id="thuong">${formatNumberHiddenK(totals.__EMPTY_14)}</td></tr>
                <tr class="must-pay">
                <td id="ketQuaLabel"></td>
                <td id="ketQuaValue" colspan="2"></td>
                </tr>
               <tr class="header"><td>Bằng chữ</td><td colspan="2" id="ketQuaBangChu" class="bang-chu-cell"></td></tr>
            </tbody>
            </table>
            <div id="excelDataTotals" data-tongdt="${totals.__EMPTY_12}" data-tonghh="${totals.__EMPTY_13}" data-thuong="${totals.__EMPTY_14}" style="display: none;"></div>
            <div id="copyrightInReport" class="copyright" style="display: none;">© 2025 by ZENG™</div>
        `;
        const reportDiv = document.getElementById("report");
        reportDiv.innerHTML = reportHTML;
        document.getElementById('actionButtonContainer').style.display = 'grid';
        document.getElementById('actionChoices').style.display = 'none';
        const toggleBtn = document.getElementById('toggleChoicesBtn');
        toggleBtn.textContent = 'Thêm tiền Thưởng/Nợ';
        toggleBtn.classList.remove('danger');
        toggleBtn.classList.add('secondary');
        updateActionButtons();
        tinhToan();
        reportDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

	function autoResizeTextarea(element) {
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }
	
    function formatAndCalculate(inputElement) {
        if (!inputElement) return;
        let originalValue = inputElement.value;
        let rawValue = originalValue.replace(/[^\d-]/g, '');
        let num = parseInt(rawValue, 10) || 0;
        inputElement.dataset.fullValue = num; 
        inputElement.value = num.toLocaleString('vi-VN');
        tinhToan();
    }
    
    function formatInputToHiddenK(inputElement) {
        const fullValue = parseFloat(inputElement.dataset.fullValue) || 0;
        inputElement.value = formatNumberHiddenK(fullValue);
    }

    function restoreFullInput(inputElement) {
        const fullValue = parseFloat(inputElement.dataset.fullValue) || 0;
        inputElement.value = fullValue.toLocaleString('vi-VN');
    }

    function toggleActionChoices() {
        const choicesDiv = document.getElementById('actionChoices');
        const toggleBtn = document.getElementById('toggleChoicesBtn');
        if (toggleBtn.textContent === 'Thêm tiền Thưởng/Nợ') {
            choicesDiv.style.display = 'grid';
            toggleBtn.textContent = 'Xoá hết Thưởng/Nợ';
            toggleBtn.classList.remove('secondary');
            toggleBtn.classList.add('danger');
        } else {
            document.getElementById('extraBonusRow')?.remove();
            document.getElementById('extraDebtRow')?.remove();
            choicesDiv.style.display = 'none';
            toggleBtn.textContent = 'Thêm tiền Thưởng/Nợ';
            toggleBtn.classList.remove('danger');
            toggleBtn.classList.add('secondary');
            updateActionButtons();
            tinhToan();
        }
    }

    function updateActionButtons() {
        const choicesDiv = document.getElementById('actionChoices');
        if (!choicesDiv) return;
        choicesDiv.innerHTML = ''; 
        if (document.getElementById('extraBonusRow')) {
            choicesDiv.innerHTML += `<button class="danger" onclick="addOrRemoveBonus()">Xoá Thưởng thêm</button>`;
        } else {
            choicesDiv.innerHTML += `<button onclick="addOrRemoveBonus()">Thêm tiền Thưởng</button>`;
        }
        if (document.getElementById('extraDebtRow')) {
            choicesDiv.innerHTML += `<button class="danger" onclick="addOrRemoveDebt()">Xoá tiền Nợ</button>`;
        } else {
            choicesDiv.innerHTML += `<button onclick="addOrRemoveDebt()">Thêm tiền Nợ</button>`;
        }
    }
    
    function addOrRemoveBonus() {
        const existingRow = document.getElementById('extraBonusRow');
        if (existingRow) {
            existingRow.remove();
        } else {
            const mainBonusRow = document.getElementById('mainBonusRow');
            if (!mainBonusRow) return;
            const newRow = document.createElement('tr');
            newRow.id = 'extraBonusRow';
            newRow.innerHTML = `
                <td style="display: flex; align-items: center;">
                    <textarea id="extraBonusNameInput" class="dynamic-input" style="color: #1e8449;" 
                          placeholder="Nhập tên thưởng..." 
                          rows="1"
                           onfocus="this.style.textAlign='right'" 
                           onblur="this.style.textAlign='center'" 
                           oninput="autoResizeTextarea(this)"
                          onkeydown="handleEnterKey(event, 'extraBonusAmountInput')"></textarea>
                </td>
                <td colspan="2">
                    <input type="text" id="extraBonusAmountInput" class="dynamic-input" style="color: #1e8449;" placeholder="Nhập số tiền..." 
                           oninput="formatAndCalculate(this)" 
                           onfocus="restoreFullInput(this)"
                           onblur="formatInputToHiddenK(this)"
                           onkeydown="handleEnterKey(event, null)" 
                           inputmode="numeric">
                </td>
            `;
            mainBonusRow.insertAdjacentElement('afterend', newRow);
            document.getElementById('extraBonusNameInput').focus();
        }
        updateActionButtons();
        tinhToan();
    }

    function addOrRemoveDebt() {
        const existingRow = document.getElementById('extraDebtRow');
        if (existingRow) {
            existingRow.remove();
        } else {
            const mainBonusRow = document.getElementById('mainBonusRow');
            if (!mainBonusRow) return;
            const anchorRow = document.getElementById('extraBonusRow') || mainBonusRow;
            const newRow = document.createElement('tr');
            newRow.id = 'extraDebtRow';
            newRow.className = 'old-debt';
            newRow.innerHTML = `
                <td style="vertical-align: middle;">Nợ cũ</td>
                <td colspan="2">
                    <input type="text" id="extraDebtAmountInput" class="dynamic-input" placeholder="Nhập số tiền nợ..." 
                           oninput="formatAndCalculate(this)"
                           onfocus="restoreFullInput(this)"
                           onblur="formatInputToHiddenK(this)"
                           onkeydown="handleEnterKey(event, null)" 
                           inputmode="numeric">
                </td>
            `;
            anchorRow.insertAdjacentElement('afterend', newRow);
            document.getElementById('extraDebtAmountInput').focus();
        }
        updateActionButtons();
        tinhToan();
    }

    function tinhToan() {
        const excelTotalsDiv = document.getElementById("excelDataTotals"); 
        if (!excelTotalsDiv) return;

        let tongDT_Excel = parseFloat(excelTotalsDiv.getAttribute('data-tongdt')) || 0;
        let tongHH_Excel = parseFloat(excelTotalsDiv.getAttribute('data-tonghh')) || 0;
        let thuong_Excel = parseFloat(excelTotalsDiv.getAttribute('data-thuong')) || 0;

        let addedRevenue = 0;
        let addedCommission = 0;

        document.querySelectorAll('.added-ticket-row').forEach(row => {
            addedRevenue += parseFloat(row.cells[1].dataset.value) || 0;
            addedCommission += parseFloat(row.cells[2].dataset.value) || 0;
        });

        let tongDT_Moi = tongDT_Excel + addedRevenue;
        let tongHH_Moi = tongHH_Excel + addedCommission;

        document.getElementById("tongDT").innerText = formatNumberHiddenK(tongDT_Moi);
        // *** CHANGE 2: Removed percentage format from Total Commission ***
        document.getElementById("tongHH").innerText = formatNumberHiddenK(tongHH_Moi);
        
        const extraBonusInput = document.getElementById('extraBonusAmountInput');
        const extraDebtInput = document.getElementById('extraDebtAmountInput');

        let extraBonusAmount = parseFloat(extraBonusInput?.dataset.fullValue || '0') || 0;
        let extraDebtAmount = parseFloat(extraDebtInput?.dataset.fullValue || '0') || 0;
      
        let phaiNop = tongDT_Moi - tongHH_Moi - thuong_Excel - extraBonusAmount + extraDebtAmount;
      
        const ketQuaLabelCell = document.getElementById("ketQuaLabel");
        const ketQuaValueCell = document.getElementById("ketQuaValue");
        let soTienBangChu = "";
        
        if (phaiNop >= 0) {
            let lamTron = Math.ceil(phaiNop / 1000) * 1000;
            if (ketQuaLabelCell) ketQuaLabelCell.innerText = 'Phải nộp:';
            if (ketQuaValueCell) ketQuaValueCell.innerText = formatNumberHiddenK(lamTron);
            soTienBangChu = docso(lamTron) + " đồng";
        } else {
            let layVe = Math.abs(phaiNop);
            if (ketQuaLabelCell) ketQuaLabelCell.innerText = 'Lấy về:';
            if (ketQuaValueCell) ketQuaValueCell.innerText = formatNumberHiddenK(layVe);
            soTienBangChu = docso(layVe) + " đồng";
        }
      
        const ketQuaBangChuCell = document.getElementById("ketQuaBangChu");
        if(ketQuaBangChuCell) { ketQuaBangChuCell.innerText = soTienBangChu; }
    }
    
    async function copyReportAsImage() {
        const reportDiv = document.getElementById("report");
        if (!reportDiv.innerHTML) { alert("Chưa có báo cáo để sao chép!"); return; }
        const copyrightInReport = document.getElementById('copyrightInReport');
        try {
            if (copyrightInReport) copyrightInReport.style.display = 'block';
            
            document.querySelectorAll('.dynamic-input').forEach(input => {
                const parent = input.parentElement;
                const hiddenValueSpan = document.createElement('span');
                hiddenValueSpan.innerText = input.value;
                hiddenValueSpan.className = 'temp-span-for-copy';
                hiddenValueSpan.style.color = input.style.color;
                parent.appendChild(hiddenValueSpan);
                input.style.display = 'none';
            });

            const canvas = await html2canvas(reportDiv, { backgroundColor: "#ffffff", scale: 2 });

            document.querySelectorAll('.dynamic-input').forEach(input => input.style.display = '');
            document.querySelectorAll('.temp-span-for-copy').forEach(span => span.remove());

            canvas.toBlob(async (blob) => {
                try {
                    await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                    alert('Copy xong ^_^. Em có thể dán (paste) vào tin nhắn Zalo. ka ka ka!!!');
                } catch (err) {
                    console.error('Lỗi khi sao chép: ', err);
                    alert('Không thể sao chép. Trình duyệt của bạn có thể không hỗ trợ hoặc cần cấp quyền.');
                }
            }, 'image/png');
        } catch (err) {
            console.error('Lỗi khi tạo ảnh: ', err);
            alert('Đã xảy ra lỗi khi cố gắng tạo ảnh.');
        } finally {
            if (copyrightInReport) copyrightInReport.style.display = 'none';
            document.querySelectorAll('.dynamic-input').forEach(input => input.style.display = '');
            document.querySelectorAll('.temp-span-for-copy').forEach(span => span.remove());
        }
    }

    toggleReportControls();
</script>

</body>
</html>
